<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Octopus Energy - Team Leaderboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const POINT_VALUES = {
      'Install Booked (LCT Install Support Pipeline)': 1,
      'EOJ': 1,
      'Customer Journey Complete (LCT Install Support Pipeline)': 5,
      'Complaint': 5,
      'Complaint Assist': 7,
      'Aged Complaint': 10
    };

    const ACTIVITY_LABELS = {
      'Install Booked (LCT Install Support Pipeline)': 'Install Booked',
      'Customer Journey Complete (LCT Install Support Pipeline)': 'Customer Live',
      'EOJ': 'CHI',
      'Complaint': 'Complaint Close',
      'Complaint Assist': 'Complaint Assist',
      'Aged Complaint': 'Aged Complaint'
    };

    const storage = {
      get: (key) => {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : null;
      },
      set: (key, value) => {
        localStorage.setItem(key, JSON.stringify(value));
      }
    };

    const TrophyIcon = () => (
      <svg className="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 24 24">
        <path d="M6 2h12v2h2a2 2 0 012 2v4a2 2 0 01-2 2h-.5A6 6 0 0112 17v3h3v2H9v-2h3v-3a6 6 0 01-7.5-5H4a2 2 0 01-2-2V6a2 2 0 012-2h2V2zm0 2v4H4V6h2zm12 0v2h2v2h-2V4zm-6 11a4 4 0 004-4V4H8v7a4 4 0 004 4z"/>
      </svg>
    );

    const UploadIcon = () => (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
      </svg>
    );

    const TrendingUpIcon = () => (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
      </svg>
    );

    const CalendarIcon = () => (
      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    );

    const OctopusIcon = () => (
      <svg className="w-12 h-12" viewBox="0 0 100 100" fill="currentColor">
        <circle cx="50" cy="35" r="20" />
        <path d="M35 50 Q30 70 25 85 M40 50 Q38 70 35 85 M45 50 Q45 70 45 85 M55 50 Q55 70 55 85 M60 50 Q62 70 65 85 M65 50 Q70 70 75 85" 
              stroke="currentColor" strokeWidth="4" fill="none" strokeLinecap="round"/>
        <circle cx="45" cy="32" r="3" fill="white" />
        <circle cx="55" cy="32" r="3" fill="white" />
      </svg>
    );

    function Leaderboard() {
      const [leaderboardData, setLeaderboardData] = useState([]);
      const [recentActivity, setRecentActivity] = useState([]);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [isDragging, setIsDragging] = useState(false);

      useEffect(() => {
        loadData();
      }, []);

const CSV_URL = "https://docs.google.com/spreadsheets/d/1JhQa1tw50kfTv1w8otW6A_Khyip7VsEQEhS4mNCUSjw/gviz/tq?tqx=out:csv&sheet=Sheet3";

const loadData = async () => {
  try {
    const response = await fetch(CSV_URL + "?t=" + Date.now());
    const text = await response.text();

    const lines = text.trim().split('\n');

    const activities = lines
      .slice(1) // ✅ Skip the header row
      .map((line, index) => {
        const parts = line.split(',');
        if (parts.length < 4) {
          console.warn(`⚠️ Skipping bad row [${index}]: ${line}`);
          return null;
        }
        const [date, type, agent, count] = parts;
        return {
          date: date.trim(),
          type: type.trim(),
          agent: agent.trim(),
          count: parseInt(count.trim())
        };
      }).filter(Boolean);

    const dataToStore = {
      activities,
      timestamp: new Date().toISOString()
    };

    storage.set('leaderboard-data', dataToStore);
    processData(activities);
    setLastUpdated(dataToStore.timestamp);

  } catch (error) {
    console.error("❌ Failed to fetch or parse leaderboard data:", error);
  }
};

    storage.set('leaderboard-data', dataToStore);
    processData(activities);
    setLas

    // Optional: store in localStorage if you still want to cache
    storage.set('leaderboard-data', dataToStore);
    processData(activities);
    setLastUpdated(dataToStore.timestamp);
  } catch (error) {
    console.error("Failed to fetch leaderboard data:", error);
  }
};


      const processData = (activities) => {
        const agentStats = {};
        
        activities.forEach(activity => {
          const { agent, type, count } = activity;
          
          if (!agentStats[agent]) {
            agentStats[agent] = {
              name: agent,
              totalPoints: 0,
              activities: {}
            };
          }
          
          const points = (POINT_VALUES[type] || 0) * count;
          agentStats[agent].totalPoints += points;
          
          if (!agentStats[agent].activities[type]) {
            agentStats[agent].activities[type] = 0;
          }
          agentStats[agent].activities[type] += count;
        });
        
        const sorted = Object.values(agentStats).sort((a, b) => b.totalPoints - a.totalPoints);
        setLeaderboardData(sorted);
        
        const recent = activities
          .slice(-10)
          .reverse()
          .map(a => ({
            ...a,
            points: (POINT_VALUES[a.type] || 0) * a.count
          }));
        setRecentActivity(recent);
      };

      const handleFileUpload = async (file) => {
        const text = await file.text();
        const lines = text.trim().split('\n');
        
        const activities = lines.map(line => {
          const [date, type, agent, count] = line.split(',');
          return {
            date: date.trim(),
            type: type.trim(),
            agent: agent.trim(),
            count: parseInt(count.trim())
          };
        });
        
        const dataToStore = {
          activities,
          timestamp: new Date().toISOString()
        };
        
        storage.set('leaderboard-data', dataToStore);
        processData(activities);
        setLastUpdated(dataToStore.timestamp);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.csv')) {
          handleFileUpload(file);
        }
      };

      const handleFileInput = (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFileUpload(file);
        }
      };

      const getMedalColor = (rank) => {
        if (rank === 0) return 'text-yellow-400';
        if (rank === 1) return 'text-gray-300';
        if (rank === 2) return 'text-orange-600';
        return 'text-gray-600';
      };

      const maxPoints = leaderboardData[0]?.totalPoints || 1;

      return (
        <div className="min-h-screen bg-gradient-to-br from-pink-500 via-purple-600 to-fuchsia-600 p-6">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="text-center mb-6">
              <div className="flex items-center justify-center gap-4 mb-3">
                <div className="text-white">
                  <OctopusIcon />
                </div>
                <h1 className="text-5xl font-black text-white tracking-tight">Team Leaderboard</h1>
              </div>
              <p className="text-pink-100 text-lg font-medium">Performance League • Powered by Octopus Energy</p>
            </div>

            {/* Compact Upload Section */}
            <div className="flex justify-center mb-6">
              <div
                className={`inline-flex items-center gap-3 border-2 border-dashed rounded-lg px-6 py-3 transition-all ${
                  isDragging ? 'border-white bg-white/20' : 'border-white/40 bg-white/10'
                }`}
                onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                onDragLeave={() => setIsDragging(false)}
                onDrop={handleDrop}
              >
                <UploadIcon />
                <div className="text-left">
                  <p className="text-white font-semibold text-sm">Update Leaderboard</p>
                  <p className="text-pink-100 text-xs">Drop CSV or click to upload</p>
                </div>
                <input
                  type="file"
                  accept=".csv"
                  onChange={handleFileInput}
                  className="hidden"
                  id="file-upload"
                />
                <label
                  htmlFor="file-upload"
                  className="px-4 py-2 bg-white text-purple-600 rounded-lg cursor-pointer hover:bg-pink-50 transition-colors font-semibold text-sm"
                >
                  Browse
                </label>
              </div>
            </div>

            {lastUpdated && (
              <p className="text-center text-pink-100 text-sm mb-6 flex items-center justify-center gap-2">
                <CalendarIcon />
                Last updated: {new Date(lastUpdated).toLocaleString()}
              </p>
            )}

            {/* Main Content */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Leaderboard - Now takes 2 columns */}
              <div className="lg:col-span-2">
                <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
                  <div className="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6">
                    <h2 className="text-2xl font-bold flex items-center gap-2">
                      <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 2h12v2h2a2 2 0 012 2v4a2 2 0 01-2 2h-.5A6 6 0 0112 17v3h3v2H9v-2h3v-3a6 6 0 01-7.5-5H4a2 2 0 01-2-2V6a2 2 0 012-2h2V2zm0 2v4H4V6h2zm12 0v2h2v2h-2V4zm-6 11a4 4 0 004-4V4H8v7a4 4 0 004 4z"/>
                      </svg>
                      Rankings
                    </h2>
                  </div>
                  <div className="divide-y">
                    {leaderboardData.length === 0 ? (
                      <div className="p-12 text-center">
                        <div className="text-gray-300 mb-4">
                          <OctopusIcon />
                        </div>
                        <p className="text-gray-500 text-lg">Upload a CSV file to see the leaderboard</p>
                      </div>
                    ) : (
                      leaderboardData.map((agent, index) => (
                        <div key={agent.name} className="p-5 hover:bg-gradient-to-r hover:from-pink-50 hover:to-purple-50 transition-all">
                          <div className="flex items-center gap-4">
                            <div className={`text-3xl font-bold w-14 text-center ${getMedalColor(index)}`}>
                              {index < 3 ? <TrophyIcon /> : `#${index + 1}`}
                            </div>
                            <div className="flex-1">
                              <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-xl text-gray-800">{agent.name}</h3>
                                <span className="text-3xl font-black bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">
                                  {agent.totalPoints}
                                </span>
                              </div>
                              <div className="w-full bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
                                <div
                                  className="bg-gradient-to-r from-pink-500 via-purple-500 to-fuchsia-500 h-3 rounded-full transition-all duration-700 shadow-lg"
                                  style={{ width: `${(agent.totalPoints / maxPoints) * 100}%` }}
                                />
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {Object.entries(agent.activities).map(([type, count]) => (
                                  <span key={type} className="bg-gradient-to-r from-pink-100 to-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-semibold">
                                    {ACTIVITY_LABELS[type] || type}: {count}
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>

              {/* Sidebar */}
              <div>
                {/* Recent Activity */}
                <div className="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
                  <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 flex items-center gap-2">
                    <TrendingUpIcon />
                    <h2 className="text-lg font-bold">Recent Activity</h2>
                  </div>
                  <div className="divide-y max-h-80 overflow-y-auto">
                    {recentActivity.length === 0 ? (
                      <div className="p-4 text-center text-gray-500 text-sm">
                        No activity yet
                      </div>
                    ) : (
                      recentActivity.map((activity, index) => (
                        <div key={index} className="p-3 hover:bg-green-50 transition-colors">
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <p className="font-semibold text-gray-800 text-sm">{activity.agent}</p>
                              <p className="text-xs text-gray-600">{ACTIVITY_LABELS[activity.type] || activity.type}</p>
                            </div>
                            <span className="text-green-600 font-bold text-sm">+{activity.points}</span>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>

                {/* Point Values */}
                <div className="bg-white rounded-2xl shadow-2xl p-5">
                  <h3 className="font-bold text-gray-800 mb-4 text-lg">Point Values</h3>
                  <div className="space-y-3">
                    {Object.entries(POINT_VALUES).map(([type, points]) => (
                      <div key={type} className="flex justify-between items-center">
                        <span className="text-gray-700 text-sm font-medium">{ACTIVITY_LABELS[type] || type}</span>
                        <span className="font-black text-lg bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">
                          {points} pts
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<Leaderboard />, document.getElementById('root'));
  </script>
</body>
</html>
